import{r as v,j as p,a as le}from"./react-CeYxiRmC.js";import{c as ce}from"./react-dom-Bwn-WS6j.js";import{x as q}from"./@lark-base-open-JC1nOszQ.js";import{E as pe}from"./exceljs-CE1UwR64.js";import{a as O}from"./axios-BTQRYGyw.js";import{_ as fe}from"./react-fast-marquee-CGcHvrpP.js";import{s as d,W as de,A as me,S as ue,a as Te,F as z,b as H,c as _e,T as K,B as Q}from"./antd-BsIkV_QJ.js";import{o as he,p as ge}from"./@ant-design-B2cxQP5Z.js";import"./classnames-BK5ccKcQ.js";import"./scheduler-CzFDRTuY.js";import"./rc-util-BCCD6kXK.js";import"./react-is-DcfIKM1A.js";import"./@babel-Da5y1lT-.js";import"./rc-resize-observer-C1qgBqSl.js";import"./resize-observer-polyfill-B1PUzC5B.js";import"./rc-motion-B9R0mXDU.js";import"./rc-select-BRKy-dw0.js";import"./rc-overflow-DbOlg5-O.js";import"./@rc-component-BuigqcIv.js";import"./rc-virtual-list-DlICWGwU.js";import"./@ctrl-DOFZgDuz.js";import"./throttle-debounce-CUWDS_la.js";import"./rc-field-form-BNNUtJf_.js";import"./rc-tooltip-CFR_xVRE.js";import"./rc-pagination-CGU6aAr5.js";import"./rc-picker-DKrISS2y.js";import"./rc-notification-C6hOZBoh.js";import"./@emotion-CW87jbl0.js";import"./stylis-DsJDcYJc.js";(function(){const L=document.createElement("link").relList;if(L&&L.supports&&L.supports("modulepreload"))return;for(const u of document.querySelectorAll('link[rel="modulepreload"]'))F(u);new MutationObserver(u=>{for(const h of u)if(h.type==="childList")for(const T of h.addedNodes)T.tagName==="LINK"&&T.rel==="modulepreload"&&F(T)}).observe(document,{childList:!0,subtree:!0});function j(u){const h={};return u.integrity&&(h.integrity=u.integrity),u.referrerPolicy&&(h.referrerPolicy=u.referrerPolicy),u.crossOrigin==="use-credentials"?h.credentials="include":u.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function F(u){if(u.ep)return;u.ep=!0;const h=j(u);fetch(u.href,h)}})();function Se(){const[U,L]=v.useState([]),[j,F]=v.useState([]),[u,h]=v.useState([]),[T,ee]=v.useState([]),[G,X]=v.useState(!1),[te,$]=v.useState(!1);v.useEffect(()=>{se()},[]);const se=async()=>{try{const D=(await q.base.getTableMetaList()).map(m=>({id:m.id,name:m.name}));if(L(D),D.some(m=>m.name==="TEST REPORT")){const m=D.find(S=>S.name==="TEST REPORT");if(m){const b=(await(await q.base.getTableById(m.id)).getRecords({pageSize:5e3})).records.map(g=>({TestPlanID:(R=>R&&typeof R=="object"&&"text"in R?R.text:"")(g.fields.fldDOnnxNv)})),_=Array.from(new Set(b.map(g=>g.TestPlanID)));_.sort((g,f)=>g.localeCompare(f,void 0,{numeric:!0})),h(_)}}}catch(c){d.warning(`${c}`)}},ae=c=>{F(c)},ie=c=>{ee(c)},oe=async()=>{X(!0);const c=[],D=[],m=[],S=[];if(T.length===0||j.length===0){d.warning("Data cannot be empty！"),X(!1);return}try{for(const t of j){const e=U.find(o=>o.id===t);if(e){const C=(await(await q.base.getTableById(e.id)).getRecords({pageSize:5e3})).records.map(s=>{var i,k,V,B,n,W,Z,J;const N=l=>{if(l===null||l===0)return"";const re=Number(l);return new Date(re).toLocaleDateString("zh-CN")},E=l=>l&&typeof l=="object"&&"text"in l?l.text:"",M=l=>l&&typeof l=="object"&&"value"in l?l.value:"";if(e.name==="TEST REPORT")return{TestPlanID:E(s.fields.fldDOnnxNv),TestCase:E(s.fields.fldIBxaE9W),ReportID:M(s.fields.fldYSYgF0O),SampleNo:Array.isArray(s.fields.fldl6frXih)?s.fields.fldl6frXih.map(l=>l.text).join(""):"",TestOperator:Array.isArray(s.fields.fldpMfv63h)?s.fields.fldpMfv63h.map(l=>l.name).join(", "):"",Timing_Act_Start:N(Number(s.fields.fld4bX8M46)),Timing_Act_Comp:N(Number(s.fields.fldKwYcalF)),Pass_NotPass:E(s.fields.fldUDrR3P5),ActualResults:Array.isArray(s.fields.fldMn41LmV)?s.fields.fldMn41LmV.map(l=>l.text).join(""):""};if(e.name==="TEST CASE LIB")return{TestID:M(s.fields.fldMN15ZM9),Part_Sub_sys_Name:Array.isArray(s.fields.fldJoh40nj)?s.fields.fldJoh40nj.map(l=>l.text).join(", "):"",Test_Classification:((i=s.fields.fldONefRCh)==null?void 0:i.text)||"",Specification_Test_Method:((V=(k=s.fields.fldGw4Zf0P)==null?void 0:k[0])==null?void 0:V.text)||"",Test_Description:Array.isArray(s.fields.fldhbfMfpT)?s.fields.fldhbfMfpT.map(l=>l.text).join(""):"",Potential_Risks:((n=(B=s.fields.fldB5XM6UQ)==null?void 0:B[0])==null?void 0:n.text)||"",Acceptance_Criteria:Array.isArray(s.fields.fldAdqjSa6)?s.fields.fldAdqjSa6.map(l=>l.text).join(""):"",Requirements_Target:((W=s.fields.fldo9XEPMo)==null?void 0:W.text)||""};if(e.name==="TEST PLAN")return{ReportName:((J=(Z=s.fields.fldoS14Fot)==null?void 0:Z[0])==null?void 0:J.text)||""}});e.name==="TEST REPORT"?c.push(...C):e.name==="TEST CASE LIB"?D.push(...C):e.name==="TEST PLAN"&&m.push(...C)}}for(const t of c)for(const e of D)t.TestCase===e.TestID&&S.push({TestID:e.TestID,Part_Sub_sys_Name:e.Part_Sub_sys_Name,Test_Classification:e.Test_Classification,Specification_Test_Method:e.Specification_Test_Method,Test_Description:e.Test_Description,Potential_Risks:e.Potential_Risks,Acceptance_Criteria:e.Acceptance_Criteria,Requirements_Target:e.Requirements_Target,ReportID:t.ReportID,Test_Case:t.TestCase,Sample_No:t.SampleNo,Test_Operator:t.TestOperator,Timing_Act_Start:t.Timing_Act_Start,Timing_Act_Comp:t.Timing_Act_Comp,Pass_Not_Pass:t.Pass_NotPass,Actual_Results:t.ActualResults,Test_Plan_ID:t.TestPlanID});S.sort((t,e)=>{const o=t.TestID.replace("TC",""),I=e.TestID.replace("TC","");return parseInt(o)-parseInt(I)});const b=S.filter(t=>t.Test_Plan_ID&&T.includes(t.Test_Plan_ID)).filter(t=>t.Test_Plan_ID===T),_=m.filter(t=>t.ReportName.includes(T))[0].ReportName,g=new pe.Workbook,f=g.addWorksheet("Sheet1"),R=["Test ID","Part/Sub-sys Name","Test Classification","Specification & Test Method","Test Description","Potential Risks","Acceptance Criteria","Requirements Target","Report ID","Test Case","Sample No","Test_Operator","Timing Act.Start","Timing_Act.Comp.","Pass/Not Pass","Actual Results","Test Plan ID"];f.addRow(R).eachCell(t=>{t.alignment={vertical:"middle",horizontal:"center"},t.font={bold:!0}}),f.columns.forEach(t=>{t.width=20});const A=b.length,a=100;for(let t=0;t<A;t+=a)b.slice(t,t+a).forEach(o=>{const I=[o.TestID,o.Part_Sub_sys_Name,o.Test_Classification,o.Specification_Test_Method,o.Test_Description,o.Potential_Risks,o.Acceptance_Criteria,o.Requirements_Target,o.ReportID,o.Test_Case,o.Sample_No,o.Test_Operator,o.Timing_Act_Start,o.Timing_Act_Comp,o.Pass_Not_Pass,o.Actual_Results,o.Test_Plan_ID];f.views=[{state:"frozen",xSplit:1,ySplit:1}];const C=f.getRow(1);C.fill={type:"pattern",pattern:"solid",fgColor:{argb:"C6EFCE"}},C.height=32,f.autoFilter={from:{row:1,column:1},to:{row:1,column:R.length}},f.getColumn("C").width=26,f.getColumn("D").width=29,f.getColumn("E").width=80,f.getColumn("K").width=20,f.getColumn("G").width=50,f.getColumn("O").width=40;const s=f.addRow(I);s.height=106,s.eachCell(N=>{N.alignment={vertical:"middle",horizontal:"center",wrapText:!0}})});const r=await g.xlsx.writeBuffer(),w=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),P=document.createElement("a");P.href=window.URL.createObjectURL(w),P.download=`${_}.xlsx`,d.success("导出成功"),P.click()}catch(x){x instanceof Error?d.warning(x.message||"导出失败"):d.warning("导出失败")}finally{X(!1)}},Y=async()=>{const c="cli_a6cfd78ef0f99009",D="SrZJzMFOp7sLGblpqQPtchOCpm2TPi5d",m="https://192.168.3.139:5173/",S=`https://open.larksuite.com/open-apis/authen/v1/index?app_id=${c}&redirect_uri=${m}&state=RANDOMSTATE`,x=window.screen.width,b=window.screen.height,_=400,g=600,f=(x-_)/2,R=(b-g)/4,y=window.open(S,"authWindow",`width=${_},height=${g},left=${f},top=${R}`),A=async()=>{try{if(y&&y.location.href.startsWith(m)){const r=new URLSearchParams(y.location.search).get("code");if(y.close(),r){const w={"Content-Type":"application/json; charset=utf-8"},P=await O.post("/open-apis/auth/v3/app_access_token/internal",{app_id:c,app_secret:D},{headers:w});if(P.data.code===0){const t={Authorization:"Bearer "+P.data.app_access_token,"Content-Type":"application/json; charset=utf-8"},e=await O.post("/open-apis/authen/v1/access_token",{grant_type:"authorization_code",code:r},{headers:t});if(e.data.code===0){const o=e.data.data.access_token;localStorage.setItem("access_token",o),d.success("授权成功！")}else d.error("授权失败！")}}else d.error("未找到授权码。")}else setTimeout(A,100)}catch{setTimeout(A,100)}};A()},ne=async()=>{$(!0);const c=[],D=[],m=[],S=[],x=localStorage.getItem("access_token");if(T.length===0||j.length===0){d.warning("Data cannot be empty！"),$(!1);return}if(!x){await Y(),d.warning("请先完成授权后，再继续上传！"),$(!1);return}try{for(const a of j){const r=U.find(w=>w.id===a);if(r){const t=(await(await q.base.getTableById(r.id)).getRecords({pageSize:5e3})).records.map(e=>{var s,N,E,M,i,k,V,B;const o=n=>{if(n===null||n===0)return"";const W=Number(n);return new Date(W).toLocaleDateString("zh-CN")},I=n=>n&&typeof n=="object"&&"text"in n?n.text:"",C=n=>n&&typeof n=="object"&&"value"in n?n.value:"";if(r.name==="TEST REPORT")return{TestPlanID:I(e.fields.fldDOnnxNv),TestCase:I(e.fields.fldIBxaE9W),ReportID:C(e.fields.fldYSYgF0O),SampleNo:Array.isArray(e.fields.fldl6frXih)?e.fields.fldl6frXih.map(n=>n.text).join(""):"",TestOperator:Array.isArray(e.fields.fldpMfv63h)?e.fields.fldpMfv63h.map(n=>n.name).join(", "):"",Timing_Act_Start:o(Number(e.fields.fld4bX8M46)),Timing_Act_Comp:o(Number(e.fields.fldKwYcalF)),Pass_NotPass:I(e.fields.fldUDrR3P5),ActualResults:Array.isArray(e.fields.fldMn41LmV)?e.fields.fldMn41LmV.map(n=>n.text).join(""):""};if(r.name==="TEST CASE LIB")return{TestID:C(e.fields.fldMN15ZM9),Part_Sub_sys_Name:Array.isArray(e.fields.fldJoh40nj)?e.fields.fldJoh40nj.map(n=>n.text).join(", "):"",Test_Classification:((s=e.fields.fldONefRCh)==null?void 0:s.text)||"",Specification_Test_Method:((E=(N=e.fields.fldGw4Zf0P)==null?void 0:N[0])==null?void 0:E.text)||"",Test_Description:Array.isArray(e.fields.fldhbfMfpT)?e.fields.fldhbfMfpT.map(n=>n.text).join(""):"",Potential_Risks:((i=(M=e.fields.fldB5XM6UQ)==null?void 0:M[0])==null?void 0:i.text)||"",Acceptance_Criteria:Array.isArray(e.fields.fldAdqjSa6)?e.fields.fldAdqjSa6.map(n=>n.text).join(""):"",Requirements_Target:((k=e.fields.fldo9XEPMo)==null?void 0:k.text)||""};if(r.name==="TEST PLAN")return{ReportName:((B=(V=e.fields.fldoS14Fot)==null?void 0:V[0])==null?void 0:B.text)||"",recordId:e.recordId,fieldId:"fldGt0iVlP"}});r.name==="TEST REPORT"?c.push(...t):r.name==="TEST CASE LIB"?D.push(...t):r.name==="TEST PLAN"&&m.push(...t)}}for(const a of c)for(const r of D)a.TestCase===r.TestID&&S.push({TestID:r.TestID,Part_Sub_sys_Name:r.Part_Sub_sys_Name,Test_Classification:r.Test_Classification,Specification_Test_Method:r.Specification_Test_Method,Test_Description:r.Test_Description,Potential_Risks:r.Potential_Risks,Acceptance_Criteria:r.Acceptance_Criteria,Requirements_Target:r.Requirements_Target,ReportID:a.ReportID,Test_Case:a.TestCase,Sample_No:a.SampleNo,Test_Operator:a.TestOperator,Timing_Act_Start:a.Timing_Act_Start,Timing_Act_Comp:a.Timing_Act_Comp,Pass_Not_Pass:a.Pass_NotPass,Actual_Results:a.ActualResults,Test_Plan_ID:a.TestPlanID});S.sort((a,r)=>{const w=a.TestID.replace("TC",""),P=r.TestID.replace("TC","");return parseInt(w)-parseInt(P)});const _=S.filter(a=>a.Test_Plan_ID&&T.includes(a.Test_Plan_ID)).filter(a=>a.Test_Plan_ID===T),g=m.filter(a=>a.ReportName.includes(T))[0].ReportName,f=m.filter(a=>a.ReportName.includes(T))[0].recordId,R=m.filter(a=>a.ReportName.includes(T))[0].fieldId,y={Authorization:"Bearer "+x,"Content-Type":"application/json; charset=utf-8"},A=await O.post("/open-apis/sheets/v3/spreadsheets",{title:g,folder_token:"GaZmfAqR7laynydFYMouUylOsfd"},{headers:y});if(A.data.code===0){const a=A.data.data.spreadsheet.spreadsheet_token,r=A.data.data.spreadsheet.url,w=await O.get(`/open-apis/sheets/v2/spreadsheets/${a}/metainfo`,{headers:y});if(A.data.code===0){const P=w.data.data.sheets[0].sheetId,t=_.length,e=100,o=200;let I=0;const C={valueRange:{range:P,values:[["Test ID","Part/Sub-sys Name","Test Classification","Specification & Test Method","Test Description","Potential Risks","Acceptance Criteria","Requirements Target","Report ID","Test Case","Sample No","Test_Operator","Timing Act.Start","Timing_Act.Comp.","Pass/Not Pass","Actual Results","Test Plan ID"]]}};await O.post(`/open-apis/sheets/v2/spreadsheets/${a}/values_prepend`,C,{headers:y});for(let s=0;s<t;s+=e){const E=_.slice(s,s+e).map(i=>[i.TestID,i.Part_Sub_sys_Name,i.Test_Classification,i.Specification_Test_Method,i.Test_Description,i.Potential_Risks,i.Acceptance_Criteria,i.Requirements_Target,i.ReportID,i.Test_Case,i.Sample_No,i.Test_Operator,i.Timing_Act_Start,i.Timing_Act_Comp,i.Pass_Not_Pass,i.Actual_Results,i.Test_Plan_ID]),M={valueRange:{range:P,values:E}};try{const i=await O.post(`/open-apis/sheets/v2/spreadsheets/${a}/values_append`,M,{headers:y});i.data.code===0?I++:d.error(i.data.code||"上传失败")}catch(i){d.error(`请求出错${i}`)}await new Promise(i=>setTimeout(i,o))}if(I===Math.ceil(t/e)){const s=await q.base.getActiveTable();await s.setCellValue(R,f,r),await s.getCellValue(R,f)?d.success("上传成功"):d.error("上传失败")}}else d.warning(A.data.code)}else d.error(A.data.code||"上传失败")}catch(b){if(b.response){const _=b.response.status;_===400||_===401?(d.error("token已过期，请重新授权。"),await Y()):d.error(`上传失败,请重新上传！Status code: ${_}`)}else d.error(`上传失败,请重新上传！${b.message}`)}finally{$(!1)}};return p.jsxs(de,{content:"仅内部使用",children:[p.jsx(me,{banner:!0,message:p.jsx(fe,{pauseOnHover:!0,gradient:!1,children:"The plug-in is currently in beta testing"})}),p.jsx(ue,{style:{width:"100%"},direction:"vertical",children:p.jsxs(Te,{size:"large",spinning:G||te,tip:G?"导出中...":"上传中...",children:[p.jsxs(z,{children:[p.jsx(z.Item,{children:p.jsx(z.Item,{label:"Select Report ID",style:{marginBottom:0},children:p.jsx(H,{showSearch:!0,placeholder:"Select Report ID",options:u.map(c=>({value:c,label:c})),onChange:ie})})}),p.jsx(z.Item,{children:p.jsx(z.Item,{label:"Select TEST PLAN/TEST REPORT/TEST CASE LIB",style:{marginBottom:0},children:p.jsx(H,{mode:"multiple",placeholder:"Select table",value:j,onChange:ae,options:U.filter(c=>c.name).map(c=>({value:c.id,label:c.name}))})})})]}),p.jsxs(_e,{gap:"small",wrap:!0,children:[p.jsx(K,{placement:"bottom",title:"导出至本地",children:p.jsx(Q,{type:"primary",icon:p.jsx(he,{}),onClick:oe,children:"导出至本地"})}),p.jsx(K,{placement:"bottom",title:"上传到TEST PLAN表Test Report字段中, 且创建的表存储在：共享空间/Test SZ 深圳共享测试数据/测试报告&用例历史记录",children:p.jsx(Q,{icon:p.jsx(ge,{}),onClick:ne,disabled:!0,children:"上传至TEST PLAN表"})})]})]})})]})}ce.createRoot(document.getElementById("root")).render(p.jsx(le.StrictMode,{children:p.jsx(Se,{})}));
